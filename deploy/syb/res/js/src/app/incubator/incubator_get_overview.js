define(["app","app/home","app/valid","lib/magnific-popup"],function(app,home,v){var id=$("#pId").val();var initEvent=function(){$(".btn-close-pro").unbind("click");$(".btn-close-pro").click(function(){var $this=$(this);var picId=$this.data("pic-id");$.ajax({url:"/company/del/pic",type:"POST",data:{picId:picId}}).done(function(data){if(data.success==true){loadingProImg();}});});$(".btn-close-env").unbind("click");$(".btn-close-env").click(function(){var $this=$(this);var picId=$this.data("pic-id");$.ajax({url:"/company/del/pic",type:"POST",data:{picId:picId}}).done(function(data){if(data.success==true){loadingEnvImg();}});});$(".img-wall").find("li").mouseover(function(){var $p=$(this).parent().parent().parent();$p.find(".img-group").find("img").attr("src",$(this).find("img").data("imgurl")+"_fixh2");$p.find(".img-group").find("a").attr("href",$(this).find("img").data("imgurl"));});$('.pro-popup').magnificPopup({delegate:'a',type:'image',tLoading:'Loading image #%curr%...',mainClass:'mfp-img-mobile',gallery:{enabled:true,navigateByImgClick:true,preload:[0,1]},image:{tError:'<a href="%url%"> #%curr%</a> 无法加载可能已删除.'}});$('.env-popup').magnificPopup({delegate:'a',type:'image',tLoading:'Loading image #%curr%...',mainClass:'mfp-img-mobile',gallery:{enabled:true,navigateByImgClick:true,preload:[0,1]},image:{tError:'<a href="%url%"> #%curr%</a> 无法加载可能已删除.'}});};var loadingProImg=function(){$.ajax({url:"/company/pic/product/"+ id,type:"POST"}).done(function(data){if(data.success==true&&data.responseData.length>0){$(".product-show-pic-ul").html($("#temp-img-li").render(data.responseData));if(data.responseData.length>0){$(".product-show-pic-box").html($("#temp-img-box").render(data.responseData[0]));}else{$(".product-show-pic-box").html("");}
$(".product-edit-pic-ul").html($("#temp-edit-pro-img").render(data.responseData));initEvent();}else{$(".product-show-pic-box").html("暂无真相");}});};var loadingEnvImg=function(){$.ajax({url:"/company/pic/env/"+ id,type:"POST"}).done(function(data){if(data.success==true&&data.responseData.length>0){$(".env-show-pic-ul").html($("#temp-img-li").render(data.responseData));if(data.responseData.length>0){$(".env-show-pic-box").html($("#temp-img-box").render(data.responseData[0]));}else{$(".env-show-pic-box").html("");}
$(".env-edit-pic-ul").html($("#temp-edit-env-img").render(data.responseData));initEvent();}else{$(".env-show-pic-box").html("暂无真相");}});};var loadingFounders=function(){$.ajax({url:"/app/incubator/founder/list/"+ id,type:"POST"}).done(function(data){if(data.success==true&&data.responseData.length>0){$(".founder-list").html($("#founder-item").render(data.responseData));if($(".add-bar").attr("data-edit")=="true"){$(".founder-del").click(function(){if(confirm("确认要删除吗?")){$.ajax({url:"/company/founder/del/"
+ $(this).data("id"),type:"POST"}).done(function(data){if(data.success==true){loadingFounders();}});}});$(".founder-edit").click(function(){var fid=$(this).data("id");var name=$(this).data("name");var title=$(this).data("title");var intro=$(this).data("intro");btn_editFun(this);$("#founder-edit-"+ $(this).data("id")).html($("#founder-item-edit").render({id:fid,nickname:name,userTitle:title,userIntro:intro}));});$(".founder-do-edit").click(function(){var fid=$(this).data("id");if(v.doValidForm($("#founder-edit-"+ fid))){$.ajax({url:"/company/founder/update/"
+ $(this).data("id"),type:"POST",data:home.generateFormData($("#founder-edit-"
+ fid))}).done(function(data){if(data.success==true){loadingFounders();}});}});$(".btn-cancel").click(function(){btn_cancelFun(this);});$(".founder-list").dragsort("destroy");$(".founder-list").dragsort({dragSelector:"li",dragBetween:true,dragEnd:function(){var data=$(".founder-list li").map(function(){return $(this).data("id");}).get();$.ajax({url:"/company/founder/updateOrder/"
+ id,type:"POST",data:{ids:data.join(",")}}).done(function(){});},placeHolderTemplate:"<li class=' founder-item placeHolder'><div></div></li>"});}}else{$(".founder-list").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;暂无小伙伴");}});};var loadingProduct=function(){$.ajax({url:"/app/incubator/product/list/"+ id,type:"POST"}).done(function(data){if(data.success==true&&data.responseData.length>0){$(".product-list").html($("#product-item").render(data.responseData));if($(".add-bar").attr("data-edit")=="true"){$(".product-del").click(function(){if(confirm("确认要删除吗?")){$.ajax({url:"/app/incubator/product/del/"
+ $(this).data("id"),type:"POST"}).done(function(data){if(data.success==true){loadingProduct();}});}});$(".product-edit").click(function(){var fid=$(this).data("id");var name=$(this).data("name");var title=$(this).data("title");var intro=$(this).data("intro");btn_editFun(this);$("#product-edit-"+ $(this).data("id")).html($("#product-edit-item").render({id:fid,nickname:name,userTitle:title,userIntro:intro}));});$(".product-do-edit").click(function(){var fid=$(this).data("id");if(v.doValidForm($("#founder-edit-"+ fid))){$.ajax({url:"/app/incubator/product/update/"
+ $(this).data("id"),type:"POST",data:home.generateFormData($("#product-edit-"
+ fid))}).done(function(data){if(data.success==true){loadingProduct();}});}});$(".btn-cancel").click(function(){btn_cancelFun(this);});$(".product-list").dragsort("destroy");$(".product-list").dragsort({dragSelector:"li",dragBetween:true,dragEnd:function(){var data=$(".product-list li").map(function(){return $(this).data("id");}).get();$.ajax({url:"/app/incubator/product/updateOrder/"
+ id,type:"POST",data:{ids:data.join(",")}}).done(function(){});},placeHolderTemplate:"<li class=' founder-item placeHolder'><div></div></li>"});}}else{}});};var btn_editFun=function($this){$($this).hide();$p=$($this).parent().parent();$p.find(".control").fadeIn();$p.find(".preview").hide();$p.find(".edit").fadeIn();$p.find(".btn-del-report").fadeIn();$p.find(".btn-del-milestone").fadeIn();};var btn_cancelFun=function($this){var $p=$($this).parent().parent().parent().parent();$p.find(".control").hide();$p.find(".btn-edit").show();$p.find(".preview").show();$p.find(".edit").hide();$p.find(".btn-del-report").hide();$p.find(".btn-del-milestone").hide();$p.find("textarea").each(function(){if($(this).data("clear")!=0){$(this).val();}});};var loadMs=function(){$.ajax({url:"/company/milestone/list",type:"POST",data:{companyId:id}}).done(function(data){if(data.success==true&&data.responseData.length>0){$(".milestone-list").html($("#temp-company-milestone").render(data.responseData));$(".milestone-list").find(".timeline-icon").tooltip();$(".btn-del-milestone").click(function(){var id=$(this).data("id");if(confirm("确认要删除吗?")){$.ajax({url:"/company/milestone/del/"+ id,type:"POST"}).done(function(data){if(data.success==true){$(".company-milestone[data-id='"+ id+"']").remove();home.success(data.message);}else{}});}});}else{$(".milestone-list").html("暂无里程碑");}});}
app.controller("incubator_get_overview",['$scope','$http',function($scope,$http){id=$("#pId").val();var loadNews=function(){$http.post("/company/reports/list",$.param({companyId:id})).success(function(data){$scope.news=data.responseData;});};loadNews();$scope.delNews=function(cur,newsId){if(confirm("确认要删除吗?")){$.ajax({url:"/company/del/report/"+ newsId,type:"POST"}).done(function(data){if(data.success==true){loadNews();home.success(data.message);}else{home.error(data.message);}});}};$scope.saveNews=function(obj){if(v.doValidForm($("#company-new-form"))){$.ajax({url:ctxRoot+"/company/add/report?companyId="
+ id,type:"POST",data:home.generateFormData($("#company-new-form"))}).done(function(data){if(data.success==true){loadNews();$scope.newsedit.status=true;$("#company-new-form").find("input").val("");home.success(data.message);}else{home.error(data.message);}});}};$("#reportUrl").keyup(function(){$(this).next().show();$.ajax({url:"/company/reports/url/title",type:"POST",timeout:100000,data:{url:$(this).val()}}).done(function(data){if(data.success==true){$(".company-new").find("input[name='title']").val(data.str);$(".company-new").show();$("#reportUrl").next().hide();}else{$(".company-new").find("input[name='title']").val("");$(".company-new").show();$("#reportUrl").next().hide();}});});id=$("#pId").val();if(!id){return;}
$(".btn-edit").click(function(){btn_editFun(this);});$(".btn-cancel").click(function(){btn_cancelFun(this);});loadingProImg();loadingEnvImg();loadingFounders();loadMs();loadingProduct();initEvent();home.converHtml();$(".btn-edit-work-env").click(function(){var $p=$(this).parent().parent();$p.find(".btn-edit-work-env").hide();$(this).next().show();$p.find(".preview").hide();$p.find(".edit").show();});$(".btn-cancel-work-env").click(function(){var $p=$(this).parent().parent().parent();$p.find(".btn-edit-work-env").show();$p.find(".control").hide();$p.find(".preview").show();$p.find(".edit").hide();});$(".btn-update-work-env").click(function(){var $p=$(this).parent().parent().parent();$.ajax({url:"/company/update/"+ id,type:"POST",data:home.generateFormData($("#textarea-work-env"))}).done(function(data){if(data.success==true&&data.responseData.work_envView.length>0){$p.find(".preview").show();$p.find(".edit").hide();$p.find(".btn-edit-work-env").show();$p.find(".control").hide();$p.find(".intro").html(data.responseData.work_envView);}else{$p.find(".preview").show();$p.find(".edit").hide();$p.find(".btn-edit-work-env").show();$p.find(".control").hide();$p.find(".intro").html("暂无文字介绍");}});});$(".btn-edit-intro").click(function(){var $p=$(this).parent().parent();$p.find(".btn-edit-intro").hide();$(this).next().show();$p.find(".preview").hide();$p.find(".edit").show();});$(".btn-cancel-intro").click(function(){var $p=$(this).parent().parent().parent();$p.find(".btn-edit-intro").show();$p.find(".control").hide();$p.find(".preview").show();$p.find(".edit").hide();});$(".btn-update-intro").click(function(){var $p=$(this).parent().parent().parent();$.ajax({url:"/company/update/"+ id,type:"POST",data:home.generateFormData($("#textarea-intro"))}).done(function(data){if(data.success==true&&data.responseData.introView.length>0){$p.find(".preview").show();$p.find(".edit").hide();$p.find(".btn-edit-intro").show();$p.find(".control").hide();$p.find(".intro").html(data.responseData.introView);}else{$p.find(".preview").show();$p.find(".edit").hide();$p.find(".btn-edit-intro").show();$p.find(".control").hide();$p.find(".intro").html("暂无文字介绍");}});});$("#founder-groups").html("");var isC=$("#pId").data("create");if(isC==true){$(".founder-input").autocomplete({select:function(event,ui){$(".founder-input").next().val(ui.item.id);$(".founder_search_photo").attr("src",ui.item.icon+"_fixhw28");$(".founder-input").prev().addClass("fa-check").removeClass("fa-times");},source:function(request,response){$(".founder_search_photo").attr("src",$(this).data("src"));$(".founder-input").prev().addClass("fa-times").removeClass("fa-check");$.ajax({url:"/people/autosearch/"+ request.term,type:"POST"}).done(function(data){if(data.success==true){response($.map(data.responseData,function(item){return{label:item.label,value:item.value,icon:item.avatar,id:item.id};}));}else{home.error(data.message);}});},_renderItem:function(ul,item){return $("<li></li>").data("item.autocomplete",item).append($("#auto-search-list").render(item)).appendTo(ul);}});$(".product-input").autocomplete({select:function(event,ui){$(".product-input").next().val(ui.item.id);$(".product_search_photo").attr("src",ui.item.icon+"_fixhw28");$(".product-input").prev().addClass("fa-check").removeClass("fa-times");},source:function(request,response){$(".founder_search_photo").attr("src",$(this).data("src"));$(".product-input").prev().addClass("fa-times").removeClass("fa-check");$.ajax({url:"/company/autosearch/"+ request.term,type:"POST"}).done(function(data){if(data.success==true){response($.map(data.responseData,function(item){return{label:item.label,value:item.value,icon:item.avatar,id:item.id};}));}else{home.error(data.message);}});},_renderItem:function(ul,item){return $("<li></li>").data("item.autocomplete",item).append($("#auto-search-list").render(item)).appendTo(ul);}});}
$(".btn-add-milestone").click(function(){if(v.doValidForm($("#company-milestone-form"))){$.ajax({url:"/company/add/milestone?companyId="+ id,type:"POST",data:home.generateFormData($("#company-milestone-form"))}).done(function(data){if(data.success==true){btn_cancelFun($(".btn-add-milestone"));loadMs();$("#company-milestone-form").find("input").val("");}else{}});}});$(".btn-add-funding").click(function(){if(v.doValidForm($("#company-funding-form"))){$.ajax({url:"/company/add/funding/"+ id,type:"POST",data:home.generateFormData($("#company-funding-form"))}).done(function(data){if(data.success==true){btn_cancelFun($(".btn-add-funding"));loadFd();$("#company-funding-form").find("input select").val("");}else{}});}});$(".btn-founder-add").click(function(){if(v.doValidForm($("#founder-form"))){$.ajax({url:ctxRoot+"/company/add/founder?companyId="
+ id,type:"POST",data:home.generateFormData($("#founder-form"))}).done(function(data){if(data.success==true){btn_cancelFun($(".btn-founder-add"));$("#founder-form").find("input").val("");$("#founder-form").find("textarea").val("");loadingFounders();home.success(data.message);}else{home.error(data.message);}});}});$(".btn-product-add").click(function(){if(v.doValidForm($("#product-form"))){$.ajax({url:ctxRoot+"/app/incubator/add/product?incubatorId="
+ id,type:"POST",data:home.generateFormData($("#product-form"))}).done(function(data){if(data.success==true){btn_cancelFun($(".btn-product-add"));$("#product-form").find("input").val("");$("#product-form").find("textarea").val("");loadingProduct();home.success(data.message);}else{home.error(data.message);}});}});$(".productPic").change(function(){var $span=$(this).prev();var $btn=$(this).parent();var $input=$(this);if($btn.attr("disabled")=="disabled"){return;}
$span.removeClass("fa-plus-square");$span.addClass("fa-spinner fa-spin");$btn.attr("disabled","disabled");var flist=$(this).val().split('\\');var length=flist.length;var fname=flist[length- 1];$.ajax({url:path+"/attachment/getYunPicInfo;jsessionid='"
+ $("#sessionUID").val(),type:"POST",data:{fileName:fname}}).done(function(data){if(data.success==true){$.ajax({url:data.responseData.postUrl,type:'POST',data:home.buildFormData(data.responseData,$input),processData:false,contentType:false}).done(function(restr){restr=$.parseJSON(restr);if(restr.code==200){$.ajax({url:"/company/add/pic",type:"POST",data:{companyId:id,url:restr.url,typeName:"productPic",type:"10001"}}).done(function(data){if(data.success==true){loadingProImg();}
$span.addClass("fa-plus-square");$span.removeClass("fa-spinner fa-spin");$btn.attr("disabled",false);$input.val("");});}else{$span.addClass("fa-plus-square");$span.removeClass("fa-spinner fa-spin");$btn.attr("disabled",false);$input.val("");}});}else{$span.addClass("fa-plus-square");$span.removeClass("fa-spinner fa-spin");$btn.attr("disabled",false);$input.val("");}});});}]);return{init:function(){}};});